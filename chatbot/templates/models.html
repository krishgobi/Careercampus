{% extends 'base.html' %}

{% block title %}AI Models - Kattral AI{% endblock %}

{% block content %}
<div class="models-page">
    <div class="page-header">
        <h1>Available AI Models</h1>
        <p>Explore our AI models and see what other users think</p>
    </div>

    <div class="models-grid-container" id="modelsPage">
        <p style="text-align: center; color: var(--text-muted);">Loading models...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadModelsPage() {
        try {
            const response = await fetch('/api/feedback/models/');
            const data = await response.json();

            if (data.models.length === 0) {
                document.getElementById('modelsPage').innerHTML = '<p class="empty-state">No models available yet.</p>';
                return;
            }

            const html = '<div class="models-grid">' + data.models.map((model, index) => `
                <div class="model-card" style="animation-delay: ${index * 0.1}s">
                    <div class="model-card-header">
                        <div class="model-icon">
                            <i class="fas ${model.provider === 'gemini' ? 'fa-gem' : model.provider === 'groq' ? 'fa-bolt' : 'fa-robot'}"></i>
                        </div>
                        <span class="provider-tag">${model.provider.toUpperCase()}</span>
                    </div>
                    <h3>${model.name}</h3>
                    <p class="model-description">${model.description}</p>
                    <div class="model-meta">
                        <div class="meta-item">
                            <i class="fas fa-star"></i>
                            <span>${model.avg_rating} (${model.feedback_count} reviews)</span>
                        </div>
                        <div class="meta-item strength">
                            <i class="fas fa-bolt"></i>
                            <span>${model.strength}</span>
                        </div>
                    </div>
                    <div class="use-cases-mini">
                        ${model.use_cases.slice(0, 3).map(uc => `<span class="use-case-chip">${uc.trim()}</span>`).join('')}
                    </div>
                    ${model.recent_feedback.length > 0 ? `
                        <div class="recent-feedback-mini">
                            <h4><i class="fas fa-comment"></i> Recent Feedback</h4>
                            ${model.recent_feedback.slice(0, 2).map(fb => `
                                <div class="feedback-mini-item">
                                    <div class="stars">${'★'.repeat(fb.rating)}${'☆'.repeat(5 - fb.rating)}</div>
                                    ${fb.comment ? `<p>"${fb.comment.substring(0, 80)}${fb.comment.length > 80 ? '...' : ''}"</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <button class="btn-review" onclick="showReviewForm('${model.model_id}', '${model.name}')">
                        <i class="fas fa-star"></i> Write a Review
                    </button>
                </div>
            `).join('') + '</div>';

            document.getElementById('modelsPage').innerHTML = html;
        } catch (error) {
            console.error('Error loading models page:', error);
            document.getElementById('modelsPage').innerHTML = '<p class="empty-state">Error loading models. Please try again.</p>';
        }
    }

    // Show review form
    function showReviewForm(modelId, modelName) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay active';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3><i class="fas fa-star"></i> Review ${modelName}</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                </div>
                <div class="modal-body">
                    <div class="review-form">
                        <div class="rating-input">
                            <label>Your Rating:</label>
                            <div class="star-rating" id="starRating">
                                <i class="far fa-star" data-rating="1"></i>
                                <i class="far fa-star" data-rating="2"></i>
                                <i class="far fa-star" data-rating="3"></i>
                                <i class="far fa-star" data-rating="4"></i>
                                <i class="far fa-star" data-rating="5"></i>
                            </div>
                        </div>
                        <div class="comment-input">
                            <label>Your Comment (optional):</label>
                            <textarea id="reviewComment" placeholder="Share your experience with this model..." rows="4"></textarea>
                        </div>
                        <button class="btn-primary" onclick="submitReview('${modelId}')">
                            <i class="fas fa-paper-plane"></i> Submit Review
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Star rating interaction
        const stars = modal.querySelectorAll('.star-rating i');
        let selectedRating = 0;

        stars.forEach(star => {
            star.addEventListener('click', function () {
                selectedRating = parseInt(this.dataset.rating);
                updateStars(selectedRating);
            });

            star.addEventListener('mouseenter', function () {
                const rating = parseInt(this.dataset.rating);
                updateStars(rating);
            });
        });

        modal.querySelector('.star-rating').addEventListener('mouseleave', function () {
            updateStars(selectedRating);
        });

        function updateStars(rating) {
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.className = 'fas fa-star';
                } else {
                    star.className = 'far fa-star';
                }
            });
        }

        // Store rating for submission
        modal.dataset.rating = selectedRating;
        modal.querySelector('.star-rating').addEventListener('click', function () {
            modal.dataset.rating = selectedRating;
        });
    }

    // Submit review
    async function submitReview(modelId) {
        const modal = document.querySelector('.modal-overlay');
        const rating = parseInt(modal.dataset.rating);
        const comment = document.getElementById('reviewComment').value.trim();

        if (!rating || rating < 1) {
            alert('Please select a rating');
            return;
        }

        try {
            const response = await fetch('/api/feedback/submit/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model_id: modelId,
                    rating: rating,
                    comment: comment
                })
            });

            const data = await response.json();

            if (data.status === 'success') {
                alert('Thank you for your review!');
                modal.remove();
                loadModelsPage(); // Reload to show new review
            } else {
                alert('Error submitting review: ' + (data.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error submitting review:', error);
            alert('Error submitting review');
        }
    }

    // Load models when page loads
    document.addEventListener('DOMContentLoaded', loadModelsPage);
</script>
{% endblock %}