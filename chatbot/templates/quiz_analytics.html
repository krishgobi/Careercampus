{% extends 'base.html' %}

{% block title %}Quiz Analytics - Kattral AI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% load static %}{% static 'css/analytics.css' %}">
{% endblock %}

{% block content %}
<div class="analytics-page">
    <div class="page-header">
        <h1><i class="fas fa-chart-line"></i> Quiz Analytics</h1>
        <p>Track your quiz performance and progress</p>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="stat-info">
                <h3 id="totalQuizzes">0</h3>
                <p>Total Quizzes</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="stat-info">
                <h3 id="avgScore">0%</h3>
                <p>Average Score</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-info">
                <h3 id="bestScore">0%</h3>
                <p>Best Score</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-info">
                <h3 id="worstScore">0%</h3>
                <p>Lowest Score</p>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
        <div class="chart-card">
            <h3><i class="fas fa-pie-chart"></i> Score Distribution</h3>
            <canvas id="scoreDistributionChart"></canvas>
        </div>

        <div class="chart-card">
            <h3><i class="fas fa-chart-line"></i> Performance Timeline</h3>
            <canvas id="performanceTimelineChart"></canvas>
        </div>
    </div>

    <!-- Quiz History Table -->
    <div class="history-card">
        <h3><i class="fas fa-history"></i> Quiz History</h3>
        <div class="table-container">
            <table id="quizHistoryTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Topic</th>
                        <th>Score</th>
                        <th>Percentage</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="quizHistoryBody">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #9ca3af;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let scoreChart, timelineChart;

    async function loadAnalytics() {
        try {
            const response = await fetch('/api/quiz/analytics/');
            const data = await response.json();

            if (data.status === 'success') {
                // Update statistics cards
                document.getElementById('totalQuizzes').textContent = data.total_quizzes;
                document.getElementById('avgScore').textContent = data.average_score + '%';
                document.getElementById('bestScore').textContent = data.best_score + '%';
                document.getElementById('worstScore').textContent = data.worst_score + '%';

                // Create charts
                createScoreDistributionChart(data.score_distribution);
                createTimelineChart(data.timeline);

                // Populate quiz history table
                populateQuizHistory(data.quiz_history);
            }
        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    }

    function createScoreDistributionChart(distribution) {
        const ctx = document.getElementById('scoreDistributionChart').getContext('2d');

        if (scoreChart) scoreChart.destroy();

        scoreChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['0-20%', '21-40%', '41-60%', '61-80%', '81-100%'],
                datasets: [{
                    data: [
                        distribution['0-20'] || 0,
                        distribution['21-40'] || 0,
                        distribution['41-60'] || 0,
                        distribution['61-80'] || 0,
                        distribution['81-100'] || 0
                    ],
                    backgroundColor: [
                        '#ef4444',
                        '#f59e0b',
                        '#eab308',
                        '#10b981',
                        '#059669'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function createTimelineChart(timeline) {
        const ctx = document.getElementById('performanceTimelineChart').getContext('2d');

        if (timelineChart) timelineChart.destroy();

        timelineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeline.map(t => t.date),
                datasets: [{
                    label: 'Score %',
                    data: timeline.map(t => t.score),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function populateQuizHistory(history) {
        const tbody = document.getElementById('quizHistoryBody');

        if (history.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">No quizzes taken yet</td></tr>';
            return;
        }

        tbody.innerHTML = history.map(quiz => `
            <tr>
                <td>${quiz.date}</td>
                <td>${quiz.topic}</td>
                <td>${quiz.score}/${quiz.total}</td>
                <td><span class="percentage-badge ${quiz.percentage >= 60 ? 'pass' : 'fail'}">${quiz.percentage}%</span></td>
                <td><span class="status-badge ${quiz.percentage >= 60 ? 'pass' : 'fail'}">${quiz.percentage >= 60 ? 'Passed' : 'Failed'}</span></td>
            </tr>
        `).join('');
    }

    // Load analytics on page load
    document.addEventListener('DOMContentLoaded', loadAnalytics);
</script>
{% endblock %}